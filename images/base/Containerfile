# Kipod Node Image
# This builds a container image suitable for running Kubernetes with CRI-O in rootless Podman
# Based on Fedora minimal for faster builds

FROM registry.fedoraproject.org/fedora-minimal:39

# Metadata
LABEL maintainer="kipod"
LABEL description="Kubernetes node image with CRI-O for rootless Podman"

# Environment variables
ENV container=podman \
    CRIO_VERSION=1.28 \
    K8S_VERSION=1.28

# Install systemd and basic tools (using microdnf for minimal image)
RUN microdnf install -y \
    systemd \
    iproute \
    iptables \
    procps-ng \
    && microdnf clean all

# Install additional required packages
RUN microdnf install -y \
    conntrack-tools \
    socat \
    ethtool \
    ebtables \
    ipset \
    curl \
    && microdnf clean all

# Configure systemd for running in a container
RUN (cd /lib/systemd/system/sysinit.target.wants/; for i in *; do [ $i == systemd-tmpfiles-setup.service ] || rm -f $i; done); \
    rm -f /lib/systemd/system/multi-user.target.wants/*; \
    rm -f /etc/systemd/system/*.wants/*; \
    rm -f /lib/systemd/system/local-fs.target.wants/*; \
    rm -f /lib/systemd/system/sockets.target.wants/*udev*; \
    rm -f /lib/systemd/system/sockets.target.wants/*initctl*; \
    rm -f /lib/systemd/system/basic.target.wants/*; \
    rm -f /lib/systemd/system/anaconda.target.wants/*;

# Install CRI-O and dependencies
RUN microdnf install -y \
    cri-o \
    cri-tools \
    containernetworking-plugins \
    fuse-overlayfs \
    slirp4netns \
    crun \
    jq \
    && microdnf clean all

# Install Kubernetes components
RUN cat <<EOF | tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v${K8S_VERSION}/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v${K8S_VERSION}/rpm/repodata/repomd.xml.key
EOF

RUN microdnf install -y \
    kubelet-${K8S_VERSION}* \
    kubeadm-${K8S_VERSION}* \
    kubectl-${K8S_VERSION}* \
    && microdnf clean all

# Configure CRI-O for rootless/nested containers
RUN mkdir -p /etc/crio/crio.conf.d

# Install crun wrapper to handle oomScoreAdj in rootless mode
COPY crun-wrapper.sh /usr/local/bin/crun-wrapper.sh
RUN chmod +x /usr/local/bin/crun-wrapper.sh && \
    mv /usr/bin/crun /usr/bin/crun.real && \
    ln -s /usr/local/bin/crun-wrapper.sh /usr/bin/crun

# CRI-O configuration for nested containers with VFS
RUN cat > /etc/crio/crio.conf.d/00-kipod.conf <<EOF
[crio]
  storage_driver = "vfs"

[crio.api]
  listen = "/var/run/crio/crio.sock"

[crio.runtime]
  cgroup_manager = "cgroupfs"
  conmon_cgroup = "pod"
  default_runtime = "crun"

  # Allow running without cgroupfs root access
  manage_ns_lifecycle = true

[crio.runtime.runtimes.crun]
  runtime_path = "/usr/bin/crun"
  runtime_type = "oci"

[crio.image]
  pause_image = "registry.k8s.io/pause:3.9"
  pause_command = "/pause"

[crio.network]
  network_dir = "/etc/cni/net.d/"
  plugin_dirs = ["/usr/libexec/cni/", "/opt/cni/bin/"]
EOF

# Configure storage.conf for VFS in nested containers
# VFS is slower but avoids overlay whiteout file issues in nested containers
RUN mkdir -p /etc/containers && cat > /etc/containers/storage.conf <<EOF
[storage]
  driver = "vfs"
  runroot = "/run/containers/storage"
  graphroot = "/var/lib/containers/storage"

[storage.options.vfs]
  # VFS driver doesn't use overlays, so no whiteout file issues
  # Critical for rootless mode - ignore chown errors
  ignore_chown_errors = "true"
EOF

# Configure crictl to use CRI-O
RUN cat > /etc/crictl.yaml <<EOF
runtime-endpoint: unix:///var/run/crio/crio.sock
image-endpoint: unix:///var/run/crio/crio.sock
timeout: 10
debug: false
EOF

# Configure CNI
RUN mkdir -p /etc/cni/net.d /opt/cni/bin

# Basic bridge CNI configuration
RUN cat > /etc/cni/net.d/10-kipod-bridge.conflist <<EOF
{
  "cniVersion": "1.0.0",
  "name": "kipod-bridge",
  "plugins": [
    {
      "type": "bridge",
      "bridge": "cni0",
      "isGateway": true,
      "ipMasq": true,
      "hairpinMode": true,
      "ipam": {
        "type": "host-local",
        "routes": [
          { "dst": "0.0.0.0/0" }
        ],
        "ranges": [
          [{ "subnet": "10.244.0.0/16" }]
        ]
      }
    },
    {
      "type": "portmap",
      "capabilities": {
        "portMappings": true
      }
    },
    {
      "type": "firewall"
    },
    {
      "type": "tuning"
    }
  ]
}
EOF

# Kernel modules configuration
RUN mkdir -p /etc/modules-load.d && cat > /etc/modules-load.d/kipod.conf <<EOF
overlay
br_netfilter
EOF

# Sysctl configuration for Kubernetes
RUN mkdir -p /etc/sysctl.d && cat > /etc/sysctl.d/99-kubernetes-cri.conf <<EOF
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# Disable swap (Kubernetes requirement)
RUN systemctl mask swap.target

# Configure kubelet to use CRI-O and allow swap
# Note: kubeadm expects KUBELET_EXTRA_ARGS in /etc/sysconfig/kubelet
# KubeletInUserNamespace: allows kubelet to run in user namespace (rootless mode)
RUN mkdir -p /etc/sysconfig
RUN cat > /etc/sysconfig/kubelet <<EOF
KUBELET_EXTRA_ARGS=--container-runtime-endpoint=unix:///var/run/crio/crio.sock --cgroup-driver=cgroupfs --fail-swap-on=false --feature-gates=KubeletInUserNamespace=true
EOF

# Configure systemd service limits for CRI-O
RUN mkdir -p /etc/systemd/system/crio.service.d && cat > /etc/systemd/system/crio.service.d/10-file-limit.conf <<EOF
[Service]
LimitNOFILE=1048576
EOF

# Enable services
RUN systemctl enable crio
RUN systemctl enable kubelet

# Create necessary directories
RUN mkdir -p /var/lib/kubelet \
    /var/lib/crio \
    /var/run/crio \
    /etc/kubernetes/manifests \
    /etc/kubernetes/pki

# Install skopeo and crane for image pre-loading
RUN microdnf install -y skopeo && microdnf clean all

# Download Kubernetes images as tarballs to avoid nested fuse-overlayfs issues
# These will be loaded into CRI-O at container startup
RUN mkdir -p /kind/images && \
    K8S_VERSION=1.28.15 && \
    for image in \
        "registry.k8s.io/kube-apiserver:v${K8S_VERSION}" \
        "registry.k8s.io/kube-controller-manager:v${K8S_VERSION}" \
        "registry.k8s.io/kube-scheduler:v${K8S_VERSION}" \
        "registry.k8s.io/kube-proxy:v${K8S_VERSION}" \
        "registry.k8s.io/pause:3.9" \
        "registry.k8s.io/etcd:3.5.15-0" \
        "registry.k8s.io/coredns/coredns:v1.10.1"; do \
            echo "Downloading image tarball: $image"; \
            filename=$(echo $image | tr '/:' '_'); \
            skopeo copy docker://$image docker-archive:/kind/images/${filename}.tar:$image; \
    done

# Set up entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

STOPSIGNAL SIGRTMIN+3

# Expose ports
EXPOSE 6443 10250 10251 10252 2379 2380

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["/sbin/init"]
