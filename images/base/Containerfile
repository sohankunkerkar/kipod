# Kipod Node Image - Optimized Build
# Kubernetes with CRI-O in rootless Podman

# Build arguments
ARG CRIO_VERSION=1.34
ARG K8S_VERSION=1.34
ARG K8S_FULL_VERSION=1.34.0

# ============================================================================
# Stage 1: Build patched CRI-O (parallel with stage 2 base setup)
# ============================================================================
FROM registry.fedoraproject.org/fedora:43 AS crio-builder

ARG CRIO_VERSION

# Install deps and clone in one layer
RUN dnf install -y --setopt=install_weak_deps=False \
  git golang make gcc glib2-devel glibc-devel glibc-static \
  libseccomp-devel systemd-devel gpgme-devel device-mapper-devel \
  && dnf clean all \
  && git clone --depth 1 --branch release-${CRIO_VERSION} \
  https://github.com/cri-o/cri-o.git /cri-o

# Build with parallel compilation
RUN cd /cri-o && make -j$(nproc)

# ============================================================================
# Stage 2: Main node image
# ============================================================================
FROM registry.fedoraproject.org/fedora-minimal:43

ARG CRIO_VERSION
ARG K8S_VERSION
ARG K8S_FULL_VERSION

LABEL maintainer="kipod" \
  description="Kubernetes node image with CRI-O for rootless Podman"

ENV container=podman \
  CRIO_VERSION=${CRIO_VERSION} \
  K8S_VERSION=${K8S_VERSION}

# Setup repos first (needed for package installs)
RUN echo -e "[cri-o]\nname=CRI-O\nbaseurl=https://download.opensuse.org/repositories/isv:/cri-o:/stable:/v${CRIO_VERSION}/rpm/\nenabled=1\ngpgcheck=1\ngpgkey=https://download.opensuse.org/repositories/isv:/cri-o:/stable:/v${CRIO_VERSION}/rpm/repodata/repomd.xml.key" > /etc/yum.repos.d/cri-o.repo \
  && echo -e "[kubernetes]\nname=Kubernetes\nbaseurl=https://pkgs.k8s.io/core:/stable:/v${K8S_VERSION}/rpm/\nenabled=1\ngpgcheck=1\ngpgkey=https://pkgs.k8s.io/core:/stable:/v${K8S_VERSION}/rpm/repodata/repomd.xml.key" > /etc/yum.repos.d/kubernetes.repo

# Single consolidated package install (biggest time saver)
RUN microdnf install -y --setopt=install_weak_deps=False \
  systemd iproute iptables procps-ng \
  conntrack-tools socat ethtool ebtables ipset curl \
  cri-tools containernetworking-plugins fuse-overlayfs conmon containers-common crun slirp4netns jq dbus \
  kubelet-${K8S_VERSION}* kubeadm-${K8S_VERSION}* kubectl-${K8S_VERSION}* \
  skopeo \
  && microdnf clean all \
  && rm -rf /var/cache/yum /var/cache/dnf

# Configure systemd for containers
RUN cd /lib/systemd/system/sysinit.target.wants/ && for i in *; do [ $i == systemd-tmpfiles-setup.service ] || rm -f $i; done \
  && rm -f /lib/systemd/system/multi-user.target.wants/* \
  /etc/systemd/system/*.wants/* \
  /lib/systemd/system/local-fs.target.wants/* \
  /lib/systemd/system/sockets.target.wants/*udev* \
  /lib/systemd/system/sockets.target.wants/*initctl* \
  /lib/systemd/system/basic.target.wants/* \
  /lib/systemd/system/anaconda.target.wants/* 2>/dev/null || true

# Copy patched CRI-O from builder
COPY --from=crio-builder /cri-o/bin/crio /usr/local/bin/crio
COPY --from=crio-builder /cri-o/bin/pinns /usr/local/bin/pinns
COPY --from=crio-builder /cri-o/contrib/systemd/crio.service /usr/lib/systemd/system/crio.service

# Download crun and runc in parallel (single layer)
RUN curl -fsSL -o /usr/bin/crun https://github.com/containers/crun/releases/download/1.25/crun-1.25-linux-amd64 & \
  curl -fsSL -o /usr/bin/runc https://github.com/opencontainers/runc/releases/download/v1.3.3/runc.amd64 & \
  wait \
  && chmod +x /usr/bin/crun /usr/bin/runc

# Create all directories in one layer
RUN mkdir -p /etc/crio/crio.conf.d /etc/cni/net.d /opt/cni/bin \
  /etc/modules-load.d /etc/sysctl.d /etc/sysconfig \
  /etc/systemd/system/crio.service.d \
  /var/lib/kubelet /var/lib/crio /var/run/crio \
  /etc/kubernetes/manifests /etc/kubernetes/pki \
  /kind/images

# Copy all config files
COPY configure-cgroup-manager.sh /usr/local/bin/configure-cgroup-manager.sh
COPY load-images.sh /usr/local/bin/load-images.sh
COPY files/crio/00-kipod.conf /etc/crio/crio.conf.d/00-kipod.conf
COPY files/storage/storage.conf /etc/containers/storage.conf
COPY files/crictl.yaml /etc/crictl.yaml
COPY files/cni/10-kipod-bridge.conflist /etc/cni/net.d/10-kipod-bridge.conflist
COPY files/modules/kipod.conf /etc/modules-load.d/kipod.conf
COPY files/sysctl/99-kubernetes-cri.conf /etc/sysctl.d/99-kubernetes-cri.conf
COPY files/kubelet/kubelet /etc/sysconfig/kubelet
COPY files/systemd/crio/10-file-limit.conf /etc/systemd/system/crio.service.d/10-file-limit.conf
COPY files/systemd/crio/20-dbus-dependency.conf /etc/systemd/system/crio.service.d/20-dbus-dependency.conf
COPY files/systemd/kipod-load-images.service /etc/systemd/system/kipod-load-images.service
COPY entrypoint.sh /usr/local/bin/entrypoint.sh

# Enable services and set permissions (single layer)
RUN chmod +x /usr/local/bin/configure-cgroup-manager.sh /usr/local/bin/entrypoint.sh /usr/local/bin/load-images.sh \
  && systemctl enable crio kubelet dbus-broker.service kipod-load-images.service \
  && systemctl mask swap.target

# Download K8s images in PARALLEL (major time saver: ~4min -> ~1min)
RUN set -e; \
  for image in \
  "registry.k8s.io/kube-apiserver:v${K8S_FULL_VERSION}" \
  "registry.k8s.io/kube-controller-manager:v${K8S_FULL_VERSION}" \
  "registry.k8s.io/kube-scheduler:v${K8S_FULL_VERSION}" \
  "registry.k8s.io/kube-proxy:v${K8S_FULL_VERSION}" \
  "registry.k8s.io/pause:3.9" \
  "registry.k8s.io/etcd:3.5.15-0" \
  "registry.k8s.io/coredns/coredns:v1.10.1"; do \
  filename=$(echo $image | tr '/:' '_'); \
  echo "Downloading: $image"; \
  skopeo copy docker://$image docker-archive:/kind/images/${filename}.tar:$image & \
  done; \
  wait; \
  echo "All images downloaded"

STOPSIGNAL SIGRTMIN+3
EXPOSE 6443 10250 10251 10252 2379 2380

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["/sbin/init"]
